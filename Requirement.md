# 価格監視アラートアプリ 要件定義書

## 1. プロジェクト概要

### 1.1 目的

ビットコインや米国株式（BigBear.ai Holdings Inc 等）の価格推移を可視化し、指定した高値・低値に達した際にメール通知を行う個人利用の監視アプリを構築する。

### 1.2 主要機能

1. 暗号通貨・株式の価格推移グラフ表示
2. 価格アラート通知（メール）
3. AI 予測チャット機能（Gemini API + Web Grounding）
4. 複数銘柄・複数アラート設定管理

---

## 2. 技術スタック

### 2.1 フロントエンド

- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **UI**: Tailwind CSS
- **チャートライブラリ**: Recharts または Chart.js
- **デザイン**: ダークモード対応、モダン UI
- **UI デザイン参考**: https://v0.app/templates/dashboard-m-o-n-k-y-b7GDYVxuoGC

### 2.2 バックエンド

- **API Routes**: Next.js API Routes
- **認証**: Google OAuth 2.0
- **メール送信**: Resend (無料枠: 月 3,000 通)
- **定期実行**: Vercel Cron Jobs (4 時間ごと)

### 2.3 データベース

- **Phase 1**: Google スプレッドシート
- **Phase 2**: Supabase (切り替え可能な設計)
- **理由**: 両方の DB 間で切り替え可能にし、コスト最適化を図る

### 2.4 外部 API

- **暗号通貨価格**: CoinGecko API (無料枠: 月 10,000 回)
- **米国株価格**: Alpha Vantage API (無料枠: 1 日 25 回)
- **AI 予測**: Google Gemini API + Web Grounding

### 2.5 デプロイ・ホスティング

- **ホスティング**: Vercel
- **環境変数管理**: Vercel Environment Variables

---

## 3. 機能要件

### 3.1 認証機能

#### 3.1.1 ログイン

- **方式**: Google OAuth 2.0
- **対象**: 個人利用（管理者アカウント 1 つのみ）
- **実装**: NextAuth.js または next-auth v5

#### 3.1.2 アクセス制御

- 未ログイン時: ログイン画面のみ表示
- ログイン後: 全機能へのアクセス可能

---

### 3.2 価格監視・アラート機能

#### 3.2.1 監視銘柄管理

- **初期対応**: 2 銘柄（ビットコイン、BigBear.ai）
- **最大数**: 5 銘柄
- **銘柄追加**: Web UI から追加・削除可能

#### 3.2.2 アラート設定

- **設定項目**:
  - 銘柄ごとに複数のアラート設定可能
  - 高値アラート（例: ビットコイン 18,000,000 円）
  - 低値アラート（例: ビットコイン 15,000,000 円）
- **設定方法**: Web UI から設定・編集・削除
- **状態管理**:
  - アラート有効/無効
  - 通知済みフラグ

#### 3.2.3 価格チェック処理

- **実行頻度**: 4 時間ごと
- **実行方法**: Vercel Cron Jobs
- **処理内容**:
  1. 登録された全銘柄の現在価格を取得
  2. アラート条件と照合
  3. 条件達成時、メール通知を送信
  4. 通知済みフラグを立てる
  5. 取得した価格データを DB/スプシに保存

#### 3.2.4 メール通知

- **送信サービス**: Resend
- **送信タイミング**: アラート条件達成時
- **通知内容**:
  - 銘柄名
  - 現在価格
  - アラート条件（高値/低値）
  - タイムスタンプ
- **送信先**: 設定されたメールアドレス（管理者）

#### 3.2.5 アラートリセット

- **方式**: Web UI にリセットボタン配置
- **動作**:
  - 通知済みフラグをクリア
  - アラート再有効化

---

### 3.3 価格データ管理

#### 3.3.1 過去データ取得（初回セットアップ）

- **対象期間**: 過去 2-3 年分
- **取得方法**:
  - CoinGecko API で過去データ一括取得（365 日制限考慮）
  - Alpha Vantage API で過去データ取得
- **保存先**: DB/スプシ
- **実行**: アプリ初回セットアップ時、または管理画面から手動実行

#### 3.3.2 定期データ蓄積

- **頻度**: 4 時間ごと（アラートチェックと同時）
- **保存データ**:
  - タイムスタンプ
  - 銘柄 ID/シンボル
  - 価格（USD, JPY）
  - 出来高（オプション）

#### 3.3.3 データ保持ポリシー

- **保存期間**: 制限なし（コスト考慮し後日調整可能）
- **データクリーンアップ**: 管理画面から古いデータ削除可能

---

### 3.4 グラフ表示機能

#### 3.4.1 表示方式

- **グラフタイプ**: シンプルな折れ線グラフ
- **データソース**:
  - 現在価格: API から直接取得（リアルタイム）
  - 過去推移: DB/スプシの履歴データ
- **表示期間**: カスタマイズ可能
  - 24 時間
  - 1 週間
  - 1 ヶ月
  - 3 ヶ月
  - 6 ヶ月
  - 1 年
  - 全期間

#### 3.4.2 UI/UX

- **デザイン**: ダークモード、モダンでスタイリッシュ
- **参考デザイン**: https://v0.app/templates/dashboard-m-o-n-k-y-b7GDYVxuoGC
  - カード型レイアウト
  - グラデーション・グラスモーフィズム効果
  - サイドバーナビゲーション
  - 統計カード・チャート配置
- **レスポンシブ**: スマホ・タブレット対応
- **インタラクティブ**:
  - ホバーで価格表示
  - ズーム・パン機能（オプション）

---

### 3.5 AI 予測チャット機能

#### 3.5.1 チャットインターフェース

- **UI**: メイン画面にチャットウィジェット配置
- **入力**: テキスト入力
- **出力**: Gemini API からの応答をストリーミング表示

#### 3.5.2 機能概要

- **ハイブリッド分析**:
  - 価格履歴データ（DB/スプシから取得）
  - 最新ニュース・市況（Web Grounding）
  - 両方を統合した予測・分析

#### 3.5.3 実装方法

- **参考実装**: https://github.com/YU-creator-web/reliable-eats/blob/main/backend/main.py
- **API**: Gemini API (gemini-pro または gemini-1.5-pro)
- **Web Grounding**: 有効化
- **コンテキスト注入**:
  - ユーザー質問
  - 対象銘柄の価格履歴データ（直近 3 ヶ月〜1 年）
  - Web Grounding で取得した最新情報

#### 3.5.4 利用例

- 「ビットコインは今後上がりそう？」
- 「BigBear.ai の最近のニュースを教えて」
- 「過去 3 ヶ月のチャートパターンからどう予測できる？」

---

## 4. データモデル

### 4.1 データベース/スプレッドシート設計

#### 4.1.1 テーブル/シート: `assets`（監視銘柄）

| カラム名   | データ型    | 説明                      |
| ---------- | ----------- | ------------------------- |
| id         | UUID/string | 銘柄 ID（主キー）         |
| symbol     | string      | シンボル（例: BTC, BBAI） |
| name       | string      | 銘柄名                    |
| type       | string      | 種別（crypto, stock）     |
| created_at | timestamp   | 作成日時                  |

#### 4.1.2 テーブル/シート: `alerts`（アラート設定）

| カラム名     | データ型    | 説明                      |
| ------------ | ----------- | ------------------------- |
| id           | UUID/string | アラート ID（主キー）     |
| asset_id     | UUID/string | 銘柄 ID（外部キー）       |
| type         | string      | high（高値）/ low（低値） |
| threshold    | number      | 閾値（価格）              |
| currency     | string      | 通貨単位（JPY, USD）      |
| is_active    | boolean     | 有効/無効                 |
| is_triggered | boolean     | 通知済みフラグ            |
| triggered_at | timestamp   | 通知日時                  |
| created_at   | timestamp   | 作成日時                  |

#### 4.1.3 テーブル/シート: `price_history`（価格履歴）

| カラム名  | データ型    | 説明                 |
| --------- | ----------- | -------------------- |
| id        | UUID/string | 履歴 ID（主キー）    |
| asset_id  | UUID/string | 銘柄 ID（外部キー）  |
| price_usd | number      | 価格（USD）          |
| price_jpy | number      | 価格（JPY）          |
| volume    | number      | 出来高（オプション） |
| timestamp | timestamp   | 記録日時             |

---

## 5. 画面設計

### 5.1 画面一覧

1. **ログイン画面** (`/login`)
2. **ダッシュボード** (`/dashboard`)
3. **銘柄管理画面** (`/assets`)
4. **アラート設定画面** (`/alerts`)
5. **AI 予測チャット** (`/chat` または ダッシュボード内埋め込み)

### 5.2 ダッシュボード（メイン画面）

#### 表示要素

- 監視銘柄一覧（カード形式）
  - 銘柄名・シンボル
  - 現在価格（リアルタイム）
  - 24 時間変動率
  - アラート設定状況
- 価格推移グラフ（銘柄ごと、またはタブ切り替え）
- AI 予測チャットウィジェット（右下または下部固定）

### 5.3 銘柄管理画面

- 登録銘柄リスト
- 新規銘柄追加フォーム
- 銘柄削除ボタン

### 5.4 アラート設定画面

- 銘柄ごとのアラート一覧
- アラート追加フォーム（銘柄選択、種別、閾値）
- アラート編集・削除・リセット

### 5.5 AI 予測チャット

- チャット履歴表示
- メッセージ入力欄
- 送信ボタン
- ストリーミング応答表示

---

## 6. 非機能要件

### 6.1 パフォーマンス

- **ページ読み込み**: 3 秒以内
- **グラフ描画**: 2 秒以内
- **AI 応答開始**: 5 秒以内

### 6.2 セキュリティ

- OAuth 2.0 による認証
- 環境変数で API キー管理
- HTTPS 通信のみ

### 6.3 可用性

- **稼働率**: Vercel の可用性に準拠
- **エラーハンドリング**: API 障害時の適切なエラー表示

### 6.4 保守性

- **コード品質**: TypeScript、ESLint、Prettier
- **コメント**: 主要処理に日本語コメント
- **DB 切り替え**: スプシ ⇔ Supabase を環境変数で切り替え可能

### 6.5 コスト

- **目標**: すべて無料枠内で運用
- **内訳**:
  - Vercel: Hobby プラン（無料）
  - CoinGecko: 無料プラン
  - Alpha Vantage: 無料プラン
  - Resend: 無料プラン（月 3,000 通）
  - Gemini API: 無料枠内（要確認）
  - Supabase: 無料プラン（Phase 2）

---

## 7. 制約事項

### 7.1 API 制限

- **CoinGecko**: 月 10,000 リクエスト
- **Alpha Vantage**: 1 日 25 リクエスト
  - 4 時間 ×6 回/日 ×2 銘柄 = 12 リクエスト/日 → 余裕あり
- **Resend**: 月 3,000 通 → アラート頻度が高い場合注意

### 7.2 データ取得精度

- 4 時間ごとのデータポイント → 急激な価格変動を捉えられない可能性
- 必要に応じて頻度調整を検討

### 7.3 過去データ

- CoinGecko 無料版: 過去 365 日まで
- それ以前のデータは外部ソースから手動インポートが必要

---

## 8. 開発フェーズ

### Phase 1: MVP（最小 viable 製品）

- [ ] Google OAuth 認証実装
- [ ] Google スプレッドシート連携
- [ ] ビットコイン・BigBear.ai 2 銘柄対応
- [ ] 価格取得・アラート通知（Resend）
- [ ] シンプルな折れ線グラフ表示
- [ ] ダークモード UI 実装
- [ ] Vercel Cron Jobs 設定
- [ ] 過去データ初期ロード機能

### Phase 2: AI 機能追加

- [ ] Gemini API 統合
- [ ] Web Grounding 有効化
- [ ] チャット UI 実装
- [ ] 価格履歴データのコンテキスト注入

### Phase 3: 機能拡張

- [ ] Supabase 対応
- [ ] DB 切り替え機能
- [ ] 銘柄追加（最大 5 銘柄）
- [ ] グラフ期間カスタマイズ
- [ ] レスポンシブデザイン最適化

### Phase 4: 改善・最適化

- [ ] パフォーマンスチューニング
- [ ] エラーハンドリング強化
- [ ] ログ・モニタリング
- [ ] テスト追加

---

## 9. 参考資料

### 9.1 ドキュメント

- Next.js 15: https://nextjs.org/docs
- Vercel Cron Jobs: https://vercel.com/docs/cron-jobs
- Resend: https://resend.com/docs
- CoinGecko API: https://www.coingecko.com/en/api/documentation
- Alpha Vantage API: https://www.alphavantage.co/documentation/
- Gemini API: https://ai.google.dev/docs

### 9.2 参考実装

- reliable-eats (Gemini Web Grounding): https://github.com/YU-creator-web/reliable-eats/blob/main/backend/main.py

---

## 10. 承認

| 項目     | 承認者         | 日付       |
| -------- | -------------- | ---------- |
| 要件定義 | [あなたの名前] | 2025-11-09 |

---

**備考**:

- 本要件定義書は開発中に適宜更新される
- 技術的制約や新たな要望により変更の可能性あり
